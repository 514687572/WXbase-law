<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.stip.net.dao.AlipayRecordsDao">
  <!--
    文件的生成时间： 2018-03-02 11:53:24.
    你应该把Mapper类的扩展方法的sql语句放在这个文件里面
  -->
  
  <resultMap id="GiftBaseResultMap" type="com.stip.net.mp.dto.AliGiftInfo" >
    <id column="giftList_gift_id" jdbcType="INTEGER" property="giftId" />
    <result column="alipayRecords_open_id" jdbcType="VARCHAR" property="openId" />
    <result column="alipayRecords_date_id" jdbcType="VARCHAR" property="dateId" />
    <result column="alipayRecords_prepay_id" jdbcType="VARCHAR" property="prepayId" />
    <result column="alipayRecords_out_trade_no" jdbcType="VARCHAR" property="outTradeNo" />
    <result column="alipayRecords_amount" jdbcType="INTEGER" property="amount" />
    <result column="alipayRecords_status" jdbcType="VARCHAR" property="status" />
    <result column="alipayRecords_created_at" jdbcType="TIMESTAMP" property="createdAt" />
    <result column="alipayRecords_updated_at" jdbcType="TIMESTAMP" property="updatedAt" />
    <result column="giftList_gift_name" jdbcType="VARCHAR" property="giftName" />
    <result column="giftList_gift_price" jdbcType="VARCHAR" property="giftPrice" />
    <result column="giftList_gift_image" jdbcType="VARCHAR" property="giftImage" />
    <result column="giftList_gift_order" jdbcType="INTEGER" property="giftOrder" />
    <result column="giftList_gift_desc" jdbcType="VARCHAR" property="giftDesc" />
    <result column="out_order_no" jdbcType="VARCHAR" property="out_order_no" />
    <result column="nickname" jdbcType="VARCHAR" property="nickname" />
    <result column="headimgurl" jdbcType="VARCHAR" property="headimgurl" />
  </resultMap>
  
	<select id="selectOutGiftListWithUser" parameterType="java.lang.String" resultMap="GiftBaseResultMap">
		SELECT
			*
		FROM
			(
				SELECT
					alipayRecords.open_id AS alipayRecords_open_id,
					alipayRecords.date_id AS alipayRecords_date_id,
					alipayRecords.prepay_id AS alipayRecords_prepay_id,
					alipayRecords.out_trade_no AS alipayRecords_out_trade_no,
					alipayRecords.amount AS alipayRecords_amount,
					alipayRecords. STATUS AS alipayRecords_status,
					alipayRecords.created_at AS alipayRecords_created_at,
					alipayRecords.updated_at AS alipayRecords_updated_at,
					giftList.gift_id AS giftList_gift_id,
					giftList.gift_name AS giftList_gift_name,
					giftList.gift_price AS giftList_gift_price,
					giftList.gift_image AS giftList_gift_image,
					giftList.gift_order AS giftList_gift_order,
					giftList.gift_desc AS giftList_gift_desc
				FROM
					alipay_records alipayRecords,
					gift_list giftList
				WHERE
					alipayRecords.open_id = #{openId,jdbcType=VARCHAR}
				AND alipayRecords.gift_id = giftList.gift_id
				AND alipayRecords. STATUS != 'illegal'
				AND alipayRecords. STATUS != 'CREATE_SUCCESS'
			) records
		LEFT JOIN (
			SELECT
				giftrecords.out_order_no AS out_order_no,
				muser.nickname AS nickname,
				muser.headimgurl AS headimgurl
			FROM
				muser muser,
				gift_records giftrecords
			WHERE
				muser.app_openid = giftrecords.in_open_id
			AND giftrecords.out_open_id = #{openId,jdbcType=VARCHAR}
		) userrecords ON records.alipayRecords_out_trade_no = userrecords.out_order_no
		ORDER BY
			records.alipayRecords_created_at DESC
	</select>
</mapper>